// ============================
// ğŸ”§ Admin Panel Script
// ============================

// æ¥æ”¶æ¥è‡ª index.html çš„æ¶ˆæ¯ï¼ˆä¾‹å¦‚åå­—é‡å¤æˆ–æ‹–åŠ¨åæ ‡ï¼‰
window.addEventListener("message", (event) => {
  const { type, payload } = event.data;

  if (type === "nameDuplicate") {
    const warningEl = document.getElementById("duplicateWarning");
    if (warningEl) {
      warningEl.textContent = `âš ï¸ åå­— "${payload}" å·²å­˜åœ¨ï¼`;
      setTimeout(() => (warningEl.textContent = ""), 3000);
    }
  }

  if (type === "flashMoved" && payload) {
    document.getElementById("flashPosX").value = payload.x;
    document.getElementById("flashPosY").value = payload.y;
  }

  if (type === "winnerMoved" && payload) {
    document.getElementById("winnerPosX").value = payload.x;
    document.getElementById("winnerPosY").value = payload.y;
  }
});

let autoSpinEnabled = true;

function sendMessage(type, payload) {
  if (window.opener && !window.opener.closed) {
    window.opener.postMessage({ type, payload }, "*");
  } else {
    alert("è¯·ä» index.html æ‰“å¼€æ­¤é¡µé¢ï¼");
  }
}

function postToMain(type, payload = null) {
  window.parent.postMessage({ type, payload }, "*");
}


// æ’å…¥åå­—
function sendInsertName() {
  const name = document.getElementById("nameInput").value.trim();
  const warningEl = document.getElementById("duplicateWarning");

  if (!name) {
    warningEl.textContent = "âš ï¸ è¯·è¾“å…¥åå­—ï¼";
    setTimeout(() => (warningEl.textContent = ""), 3000);
    return;
  }

  sendMessage("insertName", name);
  document.getElementById("nameInput").value = "";
}

// æ¸…ç©ºæ‰€æœ‰åå­—
function sendRemoveAllNames() {
  if (confirm("ç¡®è®¤æ¸…é™¤æ‰€æœ‰åå­—ï¼Ÿ")) {
    sendMessage("removeAllNames");
  }
}

// å¯¼å…¥åå•æ–‡ä»¶
function handleNameFile() {
  const file = document.getElementById("nameListUpload").files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const lines = e.target.result
      .split(/\r?\n/)
      .map((line) => line.trim())
      .filter(Boolean);
    sendMessage("uploadNameList", lines);
  };
  reader.readAsText(file);
}

// å¯¼å‡ºåå•
function sendExportNames() {
  sendMessage("requestNameExport");
}

// æ¸…ç©ºä¸­å¥–åå•
function sendClearWinners() {
  if (confirm("ç¡®è®¤æ¸…é™¤ä¸­å¥–åå•ï¼Ÿ")) {
    sendMessage("clearWinners");
  }
}

// è®¾ç½®ä¸­å¥–åå•å­—ä½“é¢œè‰²
function sendWinnerColor() {
  const color = document.getElementById("winnerColorInput").value;
  sendMessage("setWinnerColor", color);
}

// è®¾ç½®èƒŒæ™¯éŸ³ä¹éŸ³é‡
function sendVolume() {
  const vol = parseFloat(document.getElementById("volumeSlider").value);
  if (!isNaN(vol)) sendMessage("setVolume", vol);
}

// è®¾ç½®èƒŒæ™¯å›¾ç‰‡
function handleBgUpload() {
  const file = document.getElementById("bgUpload").files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    sendMessage("setBackground", e.target.result);
  };
  reader.readAsDataURL(file);
}

// æ‰‹åŠ¨æŠ½å¥–
function sendSpin() {
  sendMessage("spinNow");
}

// å¼€å…³èƒŒæ™¯éŸ³ä¹
function toggleMusicRemote() {
  sendMessage("toggleMusic");
}

// è®¾ç½® Flash åå­—é¢œè‰²
function sendFlashColor() {
  const color = document.getElementById("flashColorInput").value;
  sendMessage("setFlashColor", color);
}

// åˆ‡æ¢ Flash åå­—æ˜¯å¦é”å®šæ‹–åŠ¨
function toggleFlashLock() {
  const lockBtn = document.getElementById("flashLockBtn");
  const isLocked = localStorage.getItem("lockFlash") === "true";
  const newState = !isLocked;

  localStorage.setItem("lockFlash", newState);
  lockBtn.textContent = newState ? "ğŸ”’ å·²é”å®š Flash ä½ç½®" : "ğŸ”“ è§£é” Flash ä½ç½®";
}

// åˆ‡æ¢ Winner List æ˜¯å¦é”å®šæ‹–åŠ¨
function toggleWinnerLock() {
  const lockBtn = document.getElementById("winnerLockBtn");
  const isLocked = localStorage.getItem("lockWinner") === "true";
  const newState = !isLocked;

  localStorage.setItem("lockWinner", newState);
  lockBtn.textContent = newState ? "ğŸ”’ å·²é”å®š Winner List" : "ğŸ”“ è§£é” Winner List";
}

// åˆå§‹åŒ–çŠ¶æ€ï¼ˆé”å®šæŒ‰é’®ï¼‰
window.addEventListener("DOMContentLoaded", () => {
  const flashLocked = localStorage.getItem("lockFlash") === "true";
  const winnerLocked = localStorage.getItem("lockWinner") === "true";

  document.getElementById("flashLockBtn").textContent = flashLocked
    ? "ğŸ”’ å·²é”å®š Flash ä½ç½®"
    : "ğŸ”“ è§£é” Flash ä½ç½®";

  document.getElementById("winnerLockBtn").textContent = winnerLocked
    ? "ğŸ”’ å·²é”å®š Winner List"
    : "ğŸ”“ è§£é” Winner List";
});

// ç›‘å¬ Enter é”®
document.getElementById("nameInput").addEventListener("keydown", function (event) {
  if (event.key === "Enter") {
    sendInsertName();
  }
});

